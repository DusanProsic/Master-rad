<!-- Topbar -->
<header class="topbar">
  <h1>Finance Tracker</h1>
</header>

<main class="main">
  <div class="container">
    <!-- Form + Filters -->
    <!-- ...topbar & container unchanged... -->

<section class="grid grid-2">
  <!-- Form -->
  <form [formGroup]="financeForm" (ngSubmit)="onSubmit()" class="card finance-form">
    <div class="grid grid-3 w-full">
      <input class="input" type="text" formControlName="description" placeholder="Description" />
      <input class="input" type="number" formControlName="amount" placeholder="Amount" required />
      <select class="select" formControlName="type" required>
        <option value="expense">Expense</option>
        <option value="income">Income</option>
      </select>
    </div>

    <div class="stack">
      <!-- Goal selector shows only when income -->
      <div *ngIf="financeForm.get('type')?.value === 'income'">
        <label class="label">Associated Goal (optional)</label>
        <select class="select" formControlName="goalId">
          <option [ngValue]="null">-- None --</option>
          <option *ngFor="let goal of goals$ | async" [value]="goal.id">{{ goal.name }}</option>
        </select>
      </div>

      <!-- Selected Goal Info (PREVIEW after this entry) -->
      <div *ngIf="selectedGoalName" class="goal-info card-subtle">
        <p>
          <strong>Selected Goal:</strong> {{ selectedGoalName }}
          (Target: {{ selectedGoalTarget | currency:'RSD':'symbol':'1.0-0' }})
        </p>
        <p>Goal Progress: {{ selectedGoalProgress | number:'1.0-0' }}%</p>
        <p>Remaining: {{ selectedGoalRemaining | currency:'RSD':'symbol':'1.0-0' }}</p>

        <div class="progress-bar">
          <div class="progress" [style.width.%]="selectedGoalProgress"></div>
        </div>
      </div>
    </div>

    <div class="button-group">
      <button type="submit" class="btn">{{ editingId ? 'Update' : 'Add' }}</button>
      <button type="button" *ngIf="editingId" (click)="cancelEdit()"
              class="btn" style="background:transparent;border:1px solid var(--c-border);color:var(--c-text)">
        Cancel
      </button>
    </div>
  </form>

  <!-- Filters (type + goal only) -->
  <div class="card filters">
    <div class="grid grid-2 w-full">
      <div class="stack">
        <label class="label" for="type">Type</label>
        <select id="type" class="select" (change)="onFilterChange($event)">
          <option value="all">All</option>
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>
      </div>

      <div class="stack">
        <label class="label" for="goal">Goal</label>
        <select id="goal" class="select" (change)="onGoalFilterChange($event)">
          <option value="all">All</option>
          <option *ngFor="let goal of goals$ | async" [value]="goal.id">{{ goal.name }}</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- Entries -->
<section class="stack">
  <ul class="entries-list">
    <li *ngFor="let entry of (filteredEntries$ | async)" class="card" [class.goal-card]="entry.goalId">
      <div class="entry-header">
        <span class="entry-description">
          {{ entry.description || 'â€”' }}
          &nbsp;&mdash;&nbsp; {{ entry.amount | currency:'RSD':'symbol':'1.0-0' }}
          ({{ entry.type }})
        </span>
        <span *ngIf="entry.goalId" class="goal-tag">ðŸŽ¯ Goal</span>
      </div>

      <div *ngIf="entry.goalId" class="entry-goal-info">
        <p>
          Goal: <strong>{{ getGoalName(entry.goalId) }}</strong><br>
          Goal Progress: {{ getGoalOverallProgress(entry.goalId) | number:'1.0-0' }}%<br>
          Remaining: {{ getGoalRemaining(entry.goalId) | currency:'RSD':'symbol':'1.0-0' }}
        </p>
        <div class="progress-bar">
          <div class="progress" [style.width.%]="getGoalOverallProgress(entry.goalId)"></div>
        </div>
      </div>

      <div class="entry-actions">
        <button class="btn" (click)="editEntry(entry)">Edit</button>
        <button class="btn"
                (click)="deleteEntry(entry.id)"
                style="background:transparent;border:1px solid var(--c-border);color:var(--c-text)">
          Delete
        </button>
      </div>
    </li>
  </ul>
</section>

<!-- Summary + Chart -->
<section class="card summary-wrap">
  <div class="summary-grid" *ngIf="filteredTotals$ | async as totals">
    <p><strong>Filtered Income:</strong> {{ totals.income | currency:'RSD':'symbol':'1.0-0' }}</p>
    <p><strong>Filtered Expenses:</strong> {{ totals.expense | currency:'RSD':'symbol':'1.0-0' }}</p>
    <p><strong>Filtered Savings:</strong> {{ totals.savings | currency:'RSD':'symbol':'1.0-0' }}</p>
  </div>
  <app-finance-chart [totals$]="filteredTotals$"></app-finance-chart>
</section>

  </div>
</main>
